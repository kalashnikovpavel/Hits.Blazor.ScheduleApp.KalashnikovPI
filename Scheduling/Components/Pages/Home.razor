@page "/"
@using Microsoft.AspNetCore.Authorization
@using Scheduling.Data.Interfaces
@rendermode InteractiveServer
@attribute [Authorize]
@inject IEventService EventService

<PageTitle>Главная</PageTitle>



<!-- Форма для добавления нового события -->
<div class="mb-4 p-3 border rounded">
    <h3>Добавить новое событие</h3>
    <div class="row g-3">
        <div class="col-md-3">
            <label>Название:</label>
            <input @bind="_newEventTitle" class="form-control" />
            <label>Тип:</label>
            <select @bind="_newEventType" class="form-select">
                <option value="Лекция">Лекция</option>
                <option value="Практика">Практика</option>
                <option value="Лабораторная">Лабораторная</option>
            </select>

            <label>Преподаватель:</label>
            <select @bind="_newEventLector" class="form-select">
                <option value="Иванов И.И.">Иванов И.И.</option>
                <option value="Петров П.П.">Петров П.П.</option>
                <option value="Сидоров С.С.">Сидоров С.С.</option>
                <option value="Востриков В.И.">Востриков В.И.</option>
            </select>
            <label>Аудитория:</label>
            <input @bind="_newEventAddr" class="form-control" />
        </div>
        <div class="col-md-2">
            <label>Слот</label>
            <select @bind="_newEventSlot" class="form-select">
                <option value="1">08:00-09:35</option>
                <option value="2">09:45-11:20</option>
                <option value="3">11:30-13:05</option>
                <option value="4">13:45-15:20</option>
                <option value="5">15:30-17:05</option>
                <option value="6">17:15-18:50</option>
                <option value="7">19:00-20:25</option>
                <option value="8">20:35-22:00</option>
            </select>
        </div>
        <div class="col-md-2">
            <label>День недели:</label>
            <select @bind="_newEventDay" class="form-select">
                <option value="1">Понедельник</option>
                <option value="2">Вторник</option>
                <option value="3">Среда</option>
                <option value="4">Четверг</option>
                <option value="5">Пятница</option>
                <option value="6">Суббота</option>
            </select>
        </div>
        <div class="col-md-12 mt-2">
            <button @onclick="AddNewEvent" class="btn btn-primary">Добавить</button>
        </div>
    </div>
</div>

<!-- Таблица расписания -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Время</th>
            <th>Понедельник</th>
            <th>Вторник</th>
            <th>Среда</th>
            <th>Четверг</th>
            <th>Пятница</th>
            <th>Суббота</th>
        </tr>
    </thead>
    <tbody>
        @for (int slot = 1; slot <= 8; slot++)
        {
            <tr>
                <td>
                    @switch (slot)
                    {
                        case 1:
                            <text>08:00-09:35</text>
                            break;
                        case 2:

                            <text>09:45-11:20</text>
                            break;
                        case 3:

                            <text>11:30-13:05</text>
                            break;
                        case 4:

                            <text>13:45-15:20</text>
                            break;
                        case 5:

                            <text>15:30-17:05</text>
                            break;
                        case 6:

                            <text>17:15-18:50</text>
                            break;
                        case 7:

                            <text>19:00-20:25</text>
                            break;
                        case 8:

                            <text>20:35-22:00</text>
                            break;
                        default:

                            <text>Слот @slot</text>
                            break;
                    }
                </td>
                @for (int day = 1; day <= 6; day++) @* 1=Понедельник, 6=Суббота *@
                {
                    <td>
                        @{
                            var events = GetEventsForSlotAndDay(slot, (DayOfWeek)day);
                        }
                        @if (events.Any())
                        {
                            foreach (var ev in events)
                            {
                                <div class="event-card p-2 mb-1 border rounded">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>@ev.Title</strong><br />
                                            <small>@ev.Type</small><br />
                                            <small>@ev.Lector</small><br />
                                            <small>@ev.Addr</small>
                                        </div>
                                        <button @onclick="() => DeleteEvent(ev.Id)"
                                                class="btn btn-sm btn-danger"
                                                title="Удалить событие">
                                            ×
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                    </td>
                }
            </tr>
        }
    </tbody>
</table>

@code {
    private string _newEventTitle = "";
    private string _newEventAddr = "";
    private string _newEventLector = "";
    private string _newEventType = "";
    private int _newEventSlot = 1;
    private int _newEventDay = 1;
    private List<EventItem>? _events;

    private List<EventItem> GetEventsForSlotAndDay(int slot, DayOfWeek day)
    {
        return EventService.GetAllEvents()
            .Where(e => e.Slot == (TimeSlot)slot && e._dayOfWeek == day)
            .ToList();
    }

    private void AddNewEvent()
    {
        if (!string.IsNullOrWhiteSpace(_newEventTitle))
        {
            EventService.AddEvent(
                _newEventTitle,
                "Ауд. " + _newEventAddr,
                _newEventLector,
                _newEventType,
                (TimeSlot)_newEventSlot,
                (DayOfWeek)_newEventDay);

            // Сброс формы
            _newEventTitle = "";
            _newEventAddr = "";
            _newEventLector = "";
            _newEventType = "Лекция";
            _newEventSlot = 1;
            _newEventDay = 1;

            LoadEvents();
            StateHasChanged();
        }
    }

    private void DeleteEvent(int eventId)
    {
        EventService.RemoveEvent(eventId);
        LoadEvents();
        StateHasChanged();
    }

    private void LoadEvents()
    {
        _events = EventService.GetAllEvents();
    }

    protected override void OnInitialized()
    {
        LoadEvents();

        if (_events == null || _events.Count == 0)
        {
            // Добавляем тестовые данные с уникальными Id
            EventService.AddEvent("Математика", "Ауд. 101", "Иванов И.И.", "Лекция", TimeSlot.Slot1, DayOfWeek.Monday);
            EventService.AddEvent("Физика", "Ауд. 203", "Петров П.П.", "Практика", TimeSlot.Slot2, DayOfWeek.Tuesday);
            EventService.AddEvent("Программирование", "Ауд. 305", "Сидоров С.С.", "Лабораторная", TimeSlot.Slot3, DayOfWeek.Wednesday);
            EventService.AddEvent("Физра", "Спорт. зал", "Востриков В.И.", "Практика", TimeSlot.Slot4, DayOfWeek.Wednesday);
        }

        LoadEvents();
    }
}