@page "/"
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>Главная</PageTitle>

<h1>Расписание</h1>

<!-- Форма для добавления нового события -->
<div class="mb-4 p-3 border rounded">
    <h3>Добавить новое событие</h3>
    <div class="row g-3">
        <div class="col-md-3">
            <label>Название:</label>
            <input @bind="_newEventTitle" class="form-control" />
        </div>
        <div class="col-md-2">
            <label>Слот (1-8):</label>
            <input type="number" @bind="_newEventSlot" min="1" max="8" class="form-control" />
        </div>
        <div class="col-md-2">
            <label>День недели:</label>
            <select @bind="_newEventDay" class="form-select">
                <option value="1">Понедельник</option>
                <option value="2">Вторник</option>
                <option value="3">Среда</option>
                <option value="4">Четверг</option>
                <option value="5">Пятница</option>
                <option value="6">Суббота</option>
            </select>
        </div>
        <div class="col-md-12 mt-2">
            <button @onclick="AddNewEvent" class="btn btn-primary">Добавить</button>
        </div>
    </div>
</div>

<!-- Таблица расписания -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Время</th>
            <th>Понедельник</th>
            <th>Вторник</th>
            <th>Среда</th>
            <th>Четверг</th>
            <th>Пятница</th>
            <th>Суббота</th>
        </tr>
    </thead>
    <tbody>
        @for (int slot = 1; slot <= 8; slot++)
        {
            <tr>
                <td>
                    @switch(slot)
                    {
                        case 1: <text>08:00-09:35</text> break;
                        case 2: <text>09:45-11:20</text> break;
                        case 3: <text>11:30-13:05</text> break;
                        case 4: <text>13:45-15:20</text> break;
                        case 5: <text>15:30-17:05</text> break;
                        case 6: <text>17:15-18:50</text> break;
                        case 7: <text>19:00-20:25</text> break;
                        case 8: <text>20:35-22:00</text> break;
                        default: <text>Слот @slot</text> break;
                    }
                </td>
                @for (int day = 1; day <= 6; day++) @* 1=Понедельник, 6=Суббота *@
                {
                    <td>
                        @{
                            var events = GetEventsForSlotAndDay(slot, (DayOfWeek)day);
                        }
                        @if (events.Any())
                        {
                            foreach (var ev in events)
                            {
                                <div class="event-card p-2 mb-1 border rounded">
                                    <strong>@ev.Title</strong><br />
                                    <small>@ev.Type</small><br />
                                    <small>@ev.Lector</small><br />
                                    <small>@ev.Addr</small>
                                </div>
                            }
                        }
                    </td>
                }
            </tr>
        }
    </tbody>
</table>

@code {
    private string _newEventTitle = "";
    private int _newEventSlot = 1;
    private int _newEventDay = 1;
    private EventService _eventService  = new EventService();

    private List<EventItem> GetEventsForSlotAndDay(int slot, DayOfWeek day)
    {
        return _eventService.GetAllEvents()
            .Where(e => e.Slot == (TimeSlot)slot && e._dayOfWeek == day)
            .ToList();
    }

    private void AddNewEvent()
    {
        if (!string.IsNullOrWhiteSpace(_newEventTitle))
        {
            _eventService.AddEvent(
                _newEventTitle,
                "Адрес по умолчанию",
                "Лектор по умолчанию",
                "Тип по умолчанию",
                (TimeSlot)_newEventSlot,
                (DayOfWeek)_newEventDay);
            
            // Сброс формы
            _newEventTitle = "";
            
            // Уведомление об обновлении UI
            StateHasChanged();
        }
    }

    // Инициализация тестовых данных
    protected override void OnInitialized()
    {
        // Добавление тестовых событий
        _eventService.AddEvent("Математика", "Ауд. 101", "Иванов И.И.", "Лекция", TimeSlot.Slot1, DayOfWeek.Monday);
        _eventService.AddEvent("Физика", "Ауд. 203", "Петров П.П.", "Практика", TimeSlot.Slot2, DayOfWeek.Tuesday);
        _eventService.AddEvent("Программирование", "Ауд. 305", "Сидоров С.С.", "Лабораторная", TimeSlot.Slot3, DayOfWeek.Wednesday);
    }
}